<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tableau de Bord - Gestion Loyer</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center">Gestion de Loyer</h1>
        <div class="d-grid gap-2 col-6 mx-auto mt-4">
            <!-- Liens vers les diffÃ©rentes fonctionnalitÃ©s -->
            <a href="{{ url_for('login') }}" class="btn btn-info">ğŸ”‘ Connexion Bailleur</a>
            <a href="{{ url_for('locataire_login') }}" class="btn btn-info">ğŸ”‘ Connexion Locataire</a>
            <a href="{{ url_for('configuration') }}" class="btn btn-secondary">âš™ï¸ Configuration</a>
            <a href="{{ url_for('ajouter_locataire') }}" class="btn btn-info">â• Saisir un Locataire</a>
            <a href="{{ url_for('date_entree_locataire') }}" class="btn btn-secondary">ğŸ“… Date d'EntrÃ©e Locataire</a>
            <a href="{{ url_for('dashboard') }}" class="btn btn-primary">ğŸ“Š Tableau de Bord</a>
            <a href="{{ url_for('paiements') }}" class="btn btn-success">ğŸ’° GÃ©rer les Paiements</a>
            <a href="{{ url_for('locataires') }}" class="btn btn-warning">ğŸ  GÃ©rer les Locataires</a>
            <a href="{{ url_for('utilisateurs') }}" class="btn btn-dark">ğŸ‘¥ GÃ©rer les Utilisateurs</a>
            <a href="{{ url_for('envoyer_rappels') }}" class="btn btn-danger">ğŸ“© Envoyer les Rappels</a>
            <a href="{{ url_for('logout') }}" class="btn btn-secondary">ğŸšª DÃ©connexion</a>
        </div>
    </div>

    <!-- Scripts Bootstrap -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Scripts Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-messaging.js"></script>

    <!-- Script pour gÃ©rer les notifications Firebase -->
    <script>
        // Configuration Firebase (remplacez par vos propres valeurs)
        const firebaseConfig = {
            apiKey: "VOTRE_API_KEY",
            authDomain: "VOTRE_PROJET.firebaseapp.com",
            projectId: "VOTRE_PROJET",
            storageBucket: "VOTRE_PROJET.appspot.com",
            messagingSenderId: "VOTRE_MESSAGING_ID",
            appId: "VOTRE_APP_ID"
        };

        // Initialisation de Firebase
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        } else {
            firebase.app(); // Utilise l'instance existante si dÃ©jÃ  initialisÃ©e
        }

        // VÃ©rification si Firebase Messaging est pris en charge
        if (firebase.messaging.isSupported()) {
            const messaging = firebase.messaging();

            // Fonction pour enregistrer le token FCM cÃ´tÃ© serveur
            function enregistrerTokenFCM(token) {
                console.log("Enregistrement du token FCM sur le serveur...");
                fetch('/enregistrer_token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "token": token })
                })
                .then(response => response.json())
                .then(data => console.log("Token mis Ã  jour :", data))
                .catch(error => console.error("Erreur de mise Ã  jour du token :", error));
            }

            // Fonction pour configurer les notifications
            function configurerNotifications() {
                messaging.requestPermission()
                    .then(() => {
                        console.log("Permission accordÃ©e pour les notifications !");
                        return messaging.getToken();
                    })
                    .then(token => {
                        if (token) {
                            console.log("Token FCM rÃ©cupÃ©rÃ© :", token);
                            document.getElementById("fcm_token").value = token; // Stocker temporairement le token
                            enregistrerTokenFCM(token); // Enregistrer le token cÃ´tÃ© serveur
                        } else {
                            console.warn("Aucun token FCM gÃ©nÃ©rÃ© !");
                        }
                    })
                    .catch(err => {
                        console.error("Erreur lors de la rÃ©cupÃ©ration du token FCM :", err);
                        alert("Autorisation refusÃ©e. Activez les notifications dans les paramÃ¨tres.");
                    });
            }

            // VÃ©rifie si un ancien token est enregistrÃ© et le supprime si besoin
            messaging.getToken().then(currentToken => {
                if (currentToken) {
                    console.log("Ancien token FCM dÃ©tectÃ© :", currentToken);
                    enregistrerTokenFCM(currentToken);
                } else {
                    console.warn("Aucun token existant. Demande d'un nouveau...");
                    configurerNotifications();
                }
            });

            // Ã‰couteur pour gÃ©rer la rÃ©ception des notifications en arriÃ¨re-plan
            messaging.onMessage(payload => {
                console.log("Notification reÃ§ue :", payload);
                alert(`Nouvelle notification : ${payload.notification.title}\n${payload.notification.body}`);
            });

        } else {
            console.error("Firebase Messaging n'est pas pris en charge par ce navigateur.");
            alert("Votre navigateur ne prend pas en charge les notifications push !");
        }
    </script>

    <!-- Champ cachÃ© pour stocker le token FCM -->
    <input type="hidden" id="fcm_token" name="fcm_token">
</body>
</html>